name: Build and Test

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'README.md'
      - 'LICENSE'
      - 'docs/**'
  pull_request:
    branches:
      - main
    paths-ignore:
      - 'README.md'
      - 'LICENSE'
      - 'docs/**'

jobs:
  build:
    name: Build and Test
    runs-on: macos-13
    env:
      XCODE_PROJECT: RemoteImage.xcodeproj
      XCODE_SCHEME: RemoteImage
      COVERAGE_TARGET: RemoteImage
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Configure SSH Agent
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_DEPLOY_KEY_STUBBY }}
      - name: Install xcbeautify
        run: brew install xcbeautify
      - uses: actions/cache@v3
        name: "Cache SPM Dependencies"
        with:
          path: build/SourcePackages
          key: ${{ runner.os }}-spm-${{ hashFiles('RemoteImage.xcodeproj/project.xcworkspace/xcshareddata/swiftpm/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-
      - name: Build
        run: set -o pipefail && xcodebuild -project ${{ env.XCODE_PROJECT }} -scheme ${{ env.XCODE_SCHEME }} -destination 'platform=iOS Simulator,name=iPhone 14,OS=16.4' -derivedDataPath build -skipPackagePluginValidation build-for-testing | xcbeautify
      - name: Test
        run: set -o pipefail && xcodebuild -project ${{ env.XCODE_PROJECT }} -scheme ${{ env.XCODE_SCHEME }} -destination 'platform=iOS Simulator,name=iPhone 14,OS=16.4' -derivedDataPath build -skipPackagePluginValidation -enableCodeCoverage YES test-without-building | xcbeautify
      - name: Prepare Code Coverage
        run: set -o pipefail && xcrun llvm-cov export -format="lcov" --ignore-filename-regex="Tests|Mocks" -instr-profile=$(find build/Build -name Coverage.profdata) $(find build/Build -name ${{ env.COVERAGE_TARGET }}) > info.lcov
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          verbose: true
          fail_ci_if_error: true
